@page "/MeddyExplorer"
@using MeddyExplorerApp.Objects;
@inject MeddyExplorerSessionInfo meddyExplorerSessionInfo

@* Using MudTable for now but MudList could be nice to use too (it also has drag functionality) *@
<MudTable Items="@Items" FixedHeader="true" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm" OnRowClick="@ItemRowClickEvent" T="FileSystemInfo" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Date Modified</MudTh>
        <MudTh>Type</MudTh>
        <MudTh>Size</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Date Modified">@context.LastWriteTime</MudTd>
        <MudTd DataLabel="Type">@context.Extension</MudTd>
        <MudTd DataLabel="Size">@GetFileSystemInfoSize(context)</MudTd>
    </RowTemplate>
</MudTable>

@code 
{
    private List<FileSystemInfo> Items = new List<FileSystemInfo>();

    protected string GetFileSystemInfoSize(FileSystemInfo inFileSystemInfo)
    {
        FileInfo fileInfo = inFileSystemInfo as FileInfo;
        if (fileInfo is not null)
        {
            return fileInfo.Length.ToString();
        }
        return "";
    }

    protected override void OnInitialized()
    {
        RefreshExplorerView();
        meddyExplorerSessionInfo.OnCurrentDirChanged += OnCurrentDirChanged;
    }

    protected void RefreshExplorerView()
    {
        Items.Clear();
        string[] subfoldersPaths = Directory.GetDirectories(meddyExplorerSessionInfo.CurrentDir);
        foreach (string subfolderPath in subfoldersPaths)
        {
            Items.Add(new DirectoryInfo(subfolderPath));
        }
        string[] filesPaths = Directory.GetFiles(meddyExplorerSessionInfo.CurrentDir);
        foreach (string filePath in filesPaths)
        {
            Items.Add(new FileInfo(filePath));
        }
    }

    protected void OnCurrentDirChanged(string oldCurrentDir, string newCurrentDir)
    {
        RefreshExplorerView();
        StateHasChanged();
    }

    private void ItemRowClickEvent(TableRowClickEventArgs<FileSystemInfo> tableRowClickEventArgs)
    {
        DirectoryInfo folderInfo = tableRowClickEventArgs.Item as DirectoryInfo;
        if (folderInfo is not null)
        {
            meddyExplorerSessionInfo.CurrentDir = folderInfo.FullName;
        }
    }
}
